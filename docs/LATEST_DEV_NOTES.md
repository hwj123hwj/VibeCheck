# VibeCheck 开发进度与技术实现文档

> **项目名称**：VibeCheck (基于 LLM 语义评语的混合音乐推荐系统)
> **当前阶段**：应用层开发完成 (前端 + 后端接口)
> **最后更新**：2026-02-11

---

## 1. 整体开发进度概览

目前已完成从**数据工程**、**特征工程**到**全栈应用**的端到端闭环开发。

| 模块 | 核心功能 | 状态 |
|------|---------|------|
| **后端 API (FastAPI)** | 提供搜索、推荐、歌曲详情、歌词/音频代理接口 | ✅ 100% |
| **前端 UI (React)** | 响应式设计、魔力搜索、动态雷达图、同步歌词播放器 | ✅ 100% |
| **混合检索系统** | 意图解析 + 评语/歌词双向量召回 + TF-IDF 关键词融合 | ✅ 100% |
| **后端代理服务** | 解决网易云跨域及 VIP 歌曲播放权限判定 | ✅ 100% |

---

## 2. 关键技术问题及解决方案

在开发过程中，我们遇到了几个影响用户体验的核心痛点，并针对性地实施了技术方案：

### 2.1 歌词同步滚动与数据库局限性
*   **问题**：由于爬虫阶段为了清洗数据去掉了歌词的时间戳，导致数据库中存储的是普通文本，无法实现前端播放器的同步滚动效果。
*   **解决**：在后端新增 `/api/songs/{id}/lrc` 接口。当用户进入详情页时，服务端实时从网易云 API 获取原始带有时间戳的 LRC 格式歌词返回给前端，前端解析后配合 `<audio>` 元素的 `timeupdate` 事件实现毫秒级同步滚动。

### 2.2 浏览器跨域与 Referer 拦截 (音频播放)
*   **问题**：浏览器由于安全策略（CORS）和网易云 CDN 的 Referer 检查，无法直接用 `<audio>` 标签播放外链。
*   **解决**：构建后端**流式代理 (Stream Proxy)**。前端请求 `/api/songs/{id}/audio`，后端使用 `httpx` 带上合法的 `Referer` 头请求受保护音频流，并以 `StreamingResponse` 形式转发给前端，彻底绕过浏览器拦截。

### 2.3 VIP 歌曲播放权限处理
*   **问题**：网易云外链 API 对 VIP 歌曲会返回 404 HTML 或重定向到错误页，导致播放器加载卡死。
*   **解决**：
    *   **两级探测策略**：后端代理先尝试外链，若失败则调用解析 API 尝试获取 CDN 直链。
    *   **异常回退**：若两种方式均无法获取有效音频流（Content-Type 非音频），后端显式返回 404。
    *   **前端状态捕获**：前端播放器捕获加载错误，在 UI 上实时显示“该歌曲暂不可播放（可能是 VIP 专属）”提示，并禁用播放按钮以提升用户体验。

### 2.4 Numpy 数据序列化与 ORM 兼容
*   **问题**：`pgvector` 返回的向量在 Python 中是 Numpy 数组，直接拼接 SQL 字符串进行相似度计算时会带上 `np.float32(...)` 包装符导致 SQL 语法错误。
*   **解决**：使用 `.tolist()` 将向量转换为原生 Python 列表，再通过 `str()` 序列化为规范的数组字符串，确保 `CAST(text AS vector)` 正常执行。

---

## 3. 前端功能特性亮点

我们的前端不仅仅是一个播放器，更是一个**语义化发现平台**：

-   **魔力搜索框**：集成了 LLM 意图解析。当你输入“安静的午后”，后台会自动识别为 `vibe` (意境) 意图，并侧重于评语向量匹配；输入“后来我总算学会了”，则识别为 `lyrics` 意图，加速歌词召回。
-   **情感雷达图**：基于 `recharts` 渲染的五维情感分数（能量、悲伤、治愈、怀旧、孤独），直观展现 AI 对歌曲的语义理解。
-   **沉浸式同步歌词**：自定义实现的 `LyricsScroller` 组件，支持点击歌词跳转播放进度，具备渐变遮罩边缘效果。
-   **音乐氛围卡片**：展示 AI 生成的“意境标签”和“场景建议”（如：适合雨天漫步），让推荐不仅是音符，更是情绪。

---

## 4. 当前系统架构 (运行态)

-   **数据库**：远端 PostgreSQL (49.233.41.129:5433)，存储 5.3w+ 歌曲及向量。
-   **后端**：FastAPI (8000端口) + `uv` 管理。
-   **前端**：Vite + React (5173端口) + Tailwind CSS。
-   **代理**：Vite 代理 `/api` 到 localhost:8000。

---

## 5. 下一步规划 (Roadmap)

1.  **性能优化**：对相似度计算 SQL 增加索引优化，降低高并发下的响应延迟。
2.  **视觉动效**：增加页面切换的 `framer-motion` 动画。
3.  **用户体系**（可选）：加入“收藏夹”功能，基于用户收藏生成更个性化的 Vibe 画像。

---
*VibeCheck 开发文档 @ 2026*
