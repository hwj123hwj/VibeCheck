name: Deploy VibeCheck (Self-Hosted ZIP)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Fast ZIP Deployment via Proxy
        run: |
          echo "ğŸš€ [1/2] ç¯å¢ƒå‡†å¤‡..."
          
          # æ£€æŸ¥å¹¶å®‰è£… unzip
          if ! command -v unzip >/dev/null 2>&1; then
            echo "ğŸ”§ å®‰è£… unzip..."
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
              echo "â³ ç­‰å¾… apt é”é‡Šæ”¾..."
              sleep 2
            done
            sudo apt-get update && sudo apt-get install -y unzip
          fi
          
          PROJECT_PATH="/home/ubuntu/VibeCheck"
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªåˆ é™¤æ—§çš„ä»£ç ï¼Œä¿ç•™å¯èƒ½å­˜åœ¨çš„ .env æˆ–æ—¥å¿—ç›®å½•ï¼ˆè§†æƒ…å†µè€Œå®šï¼‰
          # ä¸ºäº†å½»åº•å¹²å‡€ï¼Œæˆ‘ä»¬æŒ‰ä½ çš„æ¨¡æ¿æ‰§è¡Œï¼Œä½†å»ºè®®é‡è¦æ•°æ®å­˜æ”¾åœ¨ Docker Volume ä¸­
          sudo rm -rf $PROJECT_PATH
          mkdir -p $PROJECT_PATH
          cd $PROJECT_PATH
          
          echo "ğŸ“¥ é€šè¿‡ä»£ç†ä¸‹è½½é¡¹ç›®æºç ..."
          curl -o project.zip -L https://ghproxy.net/https://github.com/hwj123hwj/VibeCheck/archive/refs/heads/master.zip
          
          if [ ! -f "project.zip" ]; then
            echo "âŒ é”™è¯¯: ZIP ä¸‹è½½å¤±è´¥!"
            exit 1
          fi

          echo "ğŸ“¦ è§£å‹ç¼©..."
          unzip -o project.zip
          
          echo "ğŸ“‚ æ•´ç†ç›®å½•ç»“æ„..."
          # GitHub ZIP é»˜è®¤ç”Ÿæˆ VibeCheck-master ç›®å½•
          mv VibeCheck-master/* . 2>/dev/null || true
          rm -rf VibeCheck-master project.zip
          
          echo "ğŸš€ [2/2] æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
          chmod +x deploy.sh
          ./deploy.sh
          
          echo "ğŸ‰ éƒ¨ç½²å…¨éƒ¨å®Œæˆï¼"
